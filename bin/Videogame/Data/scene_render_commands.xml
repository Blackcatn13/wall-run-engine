<?xml version="1.0" encoding="ISO-8859-1"?>
<scene_renderer_commands>
	<renderer_list>
		<render name="normal_render"/>
		<render name="gui_render"/>
		<render name="particle_viewer"/>
	</renderer_list>
	<normal_render>
		 <!--pre_render-->

		<!--<clear_scene color="true" depth="true" stencil="true"/>-->

		<set_pool_renderable_objects_technique pool="generate_shadow_map_renderable_obejcts_technique"/>
		<generate_shadow_maps />

		<begin_scene/>

		<enable_z_write/>
		<enable_z_test/>
		<disable_alpha_blend /> 

		<!--
		<set_axis />
		-->
		<set_pool_renderable_objects_technique pool="generate_deferred_shading_pool_renderable_object_technique"/>

		<set_render_target name="deferred_multiple_render_target">
			<dynamic_texture stage_id="0" name="DiffuseMapTexture" texture_width_as_frame_buffer="true" format_type="A8R8G8B8" depth_buffer="true"/>
			<dynamic_texture stage_id="1" name="LightMapTexture" texture_width_as_frame_buffer="true" format_type="A8R8G8B8"/>
			<dynamic_texture stage_id="2" name="NormalMapTexture" texture_width_as_frame_buffer="true" format_type="A8R8G8B8"/>
			<dynamic_texture stage_id="3" name="DepthMapTexture" texture_width_as_frame_buffer="true" format_type="R32F"/>
		</set_render_target>
		<clear_scene color="true" depth="false" stencil="false" use_back="true"/> 
		<set_matrices/>
		<enable_z_write/>
		<enable_z_test/>		
		
		
		<!-- Utilizando fragmento del Bloom fase 2 -->
		<render_scene layer="enabled_poly" active="true" />
		<render_scene layer="glow" active="true"/>
		<render_scene layer="lava_glow" active="true"/>
		
		<capture_frame_buffer>
			<dynamic_texture stage_id="0" name="EnabledPoly" texture_width_as_frame_buffer="true" format_type="A8R8G8B8" create_depth_stencil_buffer="false"/>
		</capture_frame_buffer>
		
		<clear_scene color="false" depth="true" stencil="false" use_back="false"/>
		
		<enable_z_write/>
		<enable_z_test/>		
	
		
		
		<render_scene layer="angry" active="true" />
		<render_scene layer="collectible" active="true" />
		<!--<render_scene layer="switches" active="true" />-->
		<render_scene layer="puzzle" active="true" />
		<render_scene layer="mov_platforms" active="true" />
		<render_scene layer="poly" active="true" />
		<render_scene layer="breakable" active="true"/>
		<!--<render_scene layer="alpha_objects" active="true"/> -->
		<render_scene layer="solid" active="true"/>
		<render_scene layer="animationLayerAux" active="true"/>
		<!--<set_pool_renderable_objects_technique pool="generate_deferred_shading_pool_renderable_object_technique_rim"/>-->
		<render_scene layer="enemies" active="true" />
		<render_scene layer="player" active="true"/>
		<set_pool_renderable_objects_technique pool="generate_deferred_shading_pool_renderable_object_technique_no_lights"/>
		<render_scene layer="AnimationStart" active="true"/>
		<set_pool_renderable_objects_technique pool="generate_deferred_shading_pool_renderable_object_technique_superp"/>
		<render_scene layer="superPiky" active="true"/>
		<!--<render_scene layer="invisible" active="true" />-->
		<enable_alpha_blend blendOP="add" blendSrc="srcalpha" blendDest="invsrcalpha"/>
		<set_pool_renderable_objects_technique pool="fade_alpha"/>
		<render_scene layer="vanishing" active="true"/>
		<disable_alpha_blend />
		<set_pool_renderable_objects_technique pool="generate_deferred_shading_pool_renderable_object_technique_lava"/>
		<set_tick tick="lava" technique="GBufferDiffuseMapTechniqueLava"/>
		<set_tick tick="lava" technique="GBufferLavaEffectTechnique"/>
		<!--<set_texture_in_stage texture_name="./Data/level4/textures/dispImage.tga" stage_id="258"/>-->
		<render_scene layer="lava" active="true"/>
		<set_pool_renderable_objects_technique pool="generate_deferred_shading_pool_renderable_object_technique_movement"/>
		<set_effect_value technique="GBufferDiffuseMapTechniqueMovement" value="ChangeUV" time="0.6"/>
		<render_scene layer="gui_message" active="true"/>
		<set_pool_renderable_objects_technique pool="generate_deferred_shading_pool_renderable_object_technique"/>
		<unset_render_target render_target="deferred_multiple_render_target" stencil_buffer="0"/>
		
		<disable_z_write/>
		<disable_z_test />
		
		<!-- Skybox -->
		<!--<set_pool_renderable_objects_technique pool="skybox_pool"/>
		<capture_frame_buffer>
			<dynamic_texture stage_id="0" name="SkyBoxTexture" texture_width_as_frame_buffer="true" format_type="A8R8G8B8"/>
		</capture_frame_buffer>
		<render_draw_quad> 
			<texture stage_id="0" file="SkyBoxTexture"/>
		</render_draw_quad>-->
		<!-- End Skybox -->
		<set_pool_renderable_objects_technique pool="draw_textured_quad_pool"/>
		<render_draw_quad> 
			<texture stage_id="0" file="LightMapTexture"/>
		</render_draw_quad>
		
		<!--<deferred_shading/>-->
		<!--<set_texture_in_stage texture_name="./Data/g_Textures/celshade.tga" stage_id="5"/>-->
		<!--<enable_alpha_blend blendOP="add" blendSrc="one" blendDest="one"/>-->
		
		<!-- OLD BASIC POLY EFFECT ////////////////////////////////////////////////////////////////////////////////// -->
		<!--<enable_z_write/>
		<enable_z_test />
		<set_pool_renderable_objects_technique pool="poly_pool"/>
		<render_scene layer="enabled_poly" active="true" />-->
		
		
		<disable_z_write/>
		<disable_z_test />
		<!-- //////////////////////////////////////////////////////////////////////////////////////////////// -->
		
		<!--<set_pool_renderable_objects_technique pool="deferred_lights_pool"/>-->
		<enable_alpha_blend blendOP="add" blendSrc="one" blendDest="one"/>
		
		<set_pool_renderable_objects_technique pool="deferred_lights_pool"/>
		
		<render_deferred_shading>
			<texture stage_id="0" file="DiffuseMapTexture"/>
			<texture stage_id="1" file="LightMapTexture"/>
			<texture stage_id="2" file="NormalMapTexture"/>
			<texture stage_id="3" file="DepthMapTexture"/>
		</render_deferred_shading>
		
		<!--<enable_alpha_blend blendOP="revsubstract" blendSrc="one" blendDest="one"/>
		<set_texture_in_stage texture_name="./Data/level4/textures/rand_nrm_tex.png" stage_id="4"/>
		<set_pool_renderable_objects_technique pool="ssao_pool"/>
		<render_draw_quad technique_name="DrawQuadSolidTechnique">
			<texture stage_id="0" file="DiffuseMapTexture"/>
			<texture stage_id="1" file="LightMapTexture"/>
			<texture stage_id="2" file="NormalMapTexture"/>
			<texture stage_id="3" file="DepthMapTexture"/>
		</render_draw_quad>-->
		
		<disable_alpha_blend />
		<disable_z_write/>
		<disable_z_test />		
		
		<enable_z_test />
		
			
		
		<enable_alpha_blend blendOP="add" blendSrc="srcalpha" blendDest="invsrcalpha"/>
		
		<set_pool_renderable_objects_technique pool="fire_billboard_pool"/>
		<billboard_render billboard="billboard001"/>
		<!--<set_pool_renderable_objects_technique pool="lava_billboard_pool"/>
		<billboard_render billboard="lava"/>-->
		<set_pool_renderable_objects_technique pool="particles_pool"/>
		<particle_render/>
		<disable_alpha_blend />
		
	
		
		<enable_alpha_blend blendOP="add" blendSrc="srcalpha" blendDest="invsrcalpha"/>		
		<set_pool_renderable_objects_technique pool="dummy_manager"/>
		<render_scene layer="alpha_objects" active="true"/>
		<disable_alpha_blend />
		

		<!-- GLOW POLY EFFECT ////////////////////////////////////////////////////////////////////////////////// -->
	
		<set_pool_renderable_objects_technique pool="glow_poly_pool"/>
		<gaussian_blur gaussian_loops="4" effect_technique_copy="DrawQuadSolidTechnique">
			<texture stage_id="0" file="EnabledPoly"/>
			<dynamic_texture stage_id="1" name="FinalPolyTexture" texture_width_as_frame_buffer="true" format_type="A8R8G8B8"/>
			<dynamic_texture stage_id="2" name="TempPolyTexture" texture_width_as_frame_buffer="true" format_type="A8R8G8B8"/>
		</gaussian_blur>
		<!--<enable_z_test/>-->
		<disable_z_write/>
		
		<set_pool_renderable_objects_technique pool="draw_textured_quad_pool"/>
		
		<enable_alpha_blend blendOP="add" blendSrc="one" blendDest="one"/>
		<render_scene layer="glow" active="true"/>
		<set_pool_renderable_objects_technique pool="poly_pool"/>
		<render_scene layer="enabled_poly" active="true" />
		<render_draw_quad technique_name="DrawQuadSolidTechnique">
			<texture stage_id="0" file="FinalPolyTexture"/>
		</render_draw_quad>
		<disable_z_test />
		<!-- //////////////////////////////////////////////////////////////////////////////////////////////// -->
		
		<enable_z_write/>
		<enable_z_test />
		
		<enable_alpha_blend blendOP="add" blendSrc="one" blendDest="one"/>
		
		<render_debug_scene layer="phisics" active="true" paint_cooking_mesh="false" cooking_mesh_name="fixbox" />
		<disable_alpha_blend />
		<check_active_poly />

		<disable_z_write/>
		<disable_z_test />
		
		
		<!--<render_scene layer="poly" active="true" />
		<enable_alpha_blend blendOP="add" blendSrc="one" blendDest="one"/>
		
		
		<disable_alpha_blend /> -->
		
		
		
		

		<!-- //////////////////////////////////////////////////////////////////////////////////////////////// -->
		<!-- Bloom pas 1	-->
		<!-- //////////////////////////////////////////////////////////////////////////////////////////////// -->
		
		<!--<capture_frame_buffer>
				<dynamic_texture stage_id="0" name="BloomCombineTexture1" texture_width_as_frame_buffer="true" format_type="A8R8G8B8"/>
		</capture_frame_buffer>
		<set_pool_renderable_objects_technique pool="apply_bloomeffect"/>
		<render_draw_quad technique_name="BloomEffect">
				<texture stage_id="0" file="DiffuseMapTexture"/>
		</render_draw_quad>-->
		
		
		
		<!-- //////////////////////////////////////////////////////////////////////////////////////////////// -->
		<!-- Bloom pas 2	-->
		<!-- ///////////////////////////-///////////////////////////////////////////////////////////////////// -->
		
		<!--<capture_frame_buffer>
			<dynamic_texture stage_id="0" name="SceneTexture" texture_width_as_frame_buffer="true" format_type="A8R8G8B8"/>
		</capture_frame_buffer>
		
		<set_pool_renderable_objects_technique pool="apply_gaussianblur"/>
		
		<gaussian_blur gaussian_loops="4" effect_technique_copy="DrawQuadSolidTechnique">
			<texture stage_id="0" file="SceneTexture"/>
			<dynamic_texture stage_id="1" name="FinalTexture" width="512" height="512" format_type="A8R8G8B8"/>
			<dynamic_texture stage_id="2" name="TempTexture" width="512" height="512" format_type="A8R8G8B8"/>
		</gaussian_blur>
		<set_pool_renderable_objects_technique pool="draw_textured_quad_pool"/>
		
		<render_draw_quad technique_name="DrawQuadSolidTechnique">
				<texture stage_id="0" file="FinalTexture"/>
		</render_draw_quad>
		
		<capture_frame_buffer>
			<dynamic_texture stage_id="0" name="TextureToCombine" texture_width_as_frame_buffer="true" format_type="A8R8G8B8"/>
		</capture_frame_buffer>-->
		
		
		<!-- //////////////////////////////////////////////////////////////////////////////////////////////// -->
		<!-- ZBlur -->
		<!-- //////////////////////////////////////////////////////////////////////////////////////////////// -->
		

		<!--<enable_alpha_blend blendOP="add" blendSrc="srcalpha" blendDest="invsrcalpha"/>
		<capture_frame_buffer>
				<dynamic_texture stage_id="0" name="DiffuseMapTexture1" texture_width_as_frame_buffer="true" format_type="A8R8G8B8"/>
		</capture_frame_buffer>
		<set_pool_renderable_objects_technique pool="ZBlurPool"/>
		<render_draw_quad technique_name="DrawQuadSolidTechnique">
				<texture stage_id="0" file="DepthMapTexture"/>
				<texture stage_id="1" file="DiffuseMapTexture1"/>
		</render_draw_quad>	
		<disable_alpha_blend />-->
		
		<!-- //////////////////////////////////////////////////////////////////////////////////////////////// -->
		<!-- Sobel -->
		<!-- //////////////////////////////////////////////////////////////////////////////////////////////// -->
		
		<capture_frame_buffer>
				<dynamic_texture stage_id="0" name="AfterDeferred" texture_width_as_frame_buffer="true" format_type="A8R8G8B8"/>
		</capture_frame_buffer>
		<set_pool_renderable_objects_technique pool="sobel_pool"/>
		<render_draw_quad> 
			<texture stage_id="0" file="AfterDeferred"/>
		</render_draw_quad> 
		<capture_frame_buffer>
				<dynamic_texture stage_id="0" name="SobelTexture" texture_width_as_frame_buffer="true" format_type="A8R8G8B8"/>
		</capture_frame_buffer>
		<set_pool_renderable_objects_technique pool="antialiasing_pool"/>
		<render_draw_quad> 
			<texture stage_id="0" file="AfterDeferred"/>
			<texture stage_id="1" file="SobelTexture"/>
		</render_draw_quad>
		
		<!-- //////////////////////////////////////////////////////////////////////////////////////////////// -->

		<!-- //////////////////////////////////////////////////////////////////////////////////////////////// -->
		<!-- Blur -->
		<!-- //////////////////////////////////////////////////////////////////////////////////////////////// -->
		<!--<enable_alpha_blend blendOP="add" blendSrc="srcalpha" blendDest="invsrcalpha"/>
		
		<capture_frame_buffer>
			<dynamic_texture stage_id="0" name="DiffuseMapTexture1" texture_width_as_frame_buffer="true" format_type="A8R8G8B8"/>
		</capture_frame_buffer>
		
		<set_pool_renderable_objects_technique pool="BlurPool"/>
		
		<render_draw_quad technique_name="DrawQuadSolidTechnique">
			<dynamic_texture stage_id="0" name="PreviousTexture" texture_width_as_frame_buffer="true" format_type="A8R8G8B8" />
			<texture stage_id="0" file="DiffuseMapTexture1"/>
			<texture stage_id="1" file="PreviousTexture"/>
		</render_draw_quad>
		
		<disable_alpha_blend />
		<capture_frame_buffer>
			<dynamic_texture stage_id="0" name="PreviousTexture" texture_width_as_frame_buffer="true" format_type="A8R8G8B8"/>
		</capture_frame_buffer>-->
		<!-- //////////////////////////////////////////////////////////////////////////////////////////////// -->
		
		
		<!-- //////////////////////////////////////////////////////////////////////////////////////////////// -->
		<!-- Bloom pas 3 -->
		<!-- //////////////////////////////////////////////////////////////////////////////////////////////// -->
		
		<!--<disable_alpha_blend/>
		<set_pool_renderable_objects_technique pool="apply_combinebloomeffect"/>
		<render_draw_quad>
				<texture stage_id="0" file="BloomCombineTexture1"/>
				<texture stage_id="1" file="TextureToCombine"/>
		</render_draw_quad>-->
		
		<!-- //////////////////////////////////////////////////////////////////////////////////////////////// -->
		

		<!-- Segunda pasada TODO-->
		<!-- <set_matrices/>
		<enable_z_write/>
		<enable_z_test/>
		<set_axis /> -->
		<!--
		<clear_scene color="true" depth="true" stencil="true"/> 
		<set_matrices/>
		<enable_z_write/>
		<enable_z_test/>
		<set_pool_renderable_objects_technique pool="dummy_manager"/>
		<render_scene layer="solid" active="true"/>
		-->
		<!--Fog-->
		<!--<enable_alpha_blend blendOP="add" blendSrc="srcalpha" blendDest="invsrcalpha" alphablendSrc="one" alphablendDest="one" />
		<set_pool_renderable_objects_technique pool="fog_pool"/>
		<render_draw_quad> 
			<texture stage_id="0" file="DepthMapTexture"/>
		</render_draw_quad> 
		<disable_alpha_blend />-->
		<!--End Fog-->	
		
		<!-- NOISE AND VIGNETING -->
		<capture_frame_buffer>
			<dynamic_texture stage_id="0" name="FrameBuffer" texture_width_as_frame_buffer="true" format_type="A8R8G8B8"/>
		</capture_frame_buffer>
		<enable_alpha_blend blendOP="add" blendSrc="srcalpha" blendDest="invsrcalpha"/>
		<set_pool_renderable_objects_technique pool="draw_vignetting"/>
		<render_draw_quad>
			<texture stage_id="0" file="FrameBuffer"/>
			<texture stage_id="1" file="./data/level4/textures/noise2d.png" load_file="true"/>
			<texture stage_id="2" file="./data/level4/textures/Vignetting.tga" load_file="true"/>
		</render_draw_quad>
		<!-- END NOISE AND VIGNETING -->
		<!--<enable_z_test/> -->
		<!--render_gui/-->
		 <!--<render_debug_scene layer="solid" active="true"/>-->

		<!--<disable_z_write/>-->
	
		<!--<enable_z_write/>
		<enable_z_test /> -->


		<disable_z_test/>
		<disable_z_write/>
		
		<enable_alpha_blend blendOP="add" blendSrc="srcalpha" blendDest="invsrcalpha"/>
		
		<render_gui/>
		<render_debug_info/>
		
		<disable_alpha_blend /> 
		<!-- <capture_frame_buffer> 
			<dynamic_texture stage_id="0" name="MyTexture" texture_width_as_frame_buffer="true" format_type="A8R8G8B8"/>
		</capture_frame_buffer> -->
		<end_scene/>
		<!--end pre_render-->
		<present/>
	</normal_render>

	<gui_render >
		<clear_scene color="true" depth="true" stencil="true"/>
		<begin_scene/>
		<render_scene layer="player" active="true"/>
		<enable_alpha_blend blendOP="add" blendSrc="srcalpha" blendDest="invsrcalpha"/>
		<render_gui/>
		<end_scene/>
		<present/>
	</gui_render>

	<particle_viewer active="true">
		<clear_scene color="true" depth="true" stencil="true"/>
		<begin_scene/>
		<set_matrices/>
		<disable_z_test/>
		<disable_z_write/>
		<enable_alpha_blend blendOP="add" blendSrc="srcalpha" blendDest="invsrcalpha"/>
		<set_pool_renderable_objects_technique pool="particles_pool"/>
		<particle_render/>
		<render_gui/>
		<render_debug_info/>
		
		<disable_alpha_blend /> 
		<end_scene/>
		<present/>
	</particle_viewer>
</scene_renderer_commands>